{% extends "base.html" %}
{% block title %}Book Appointment{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
  <div class="bg-white shadow sm:rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900">Book a New Appointment</h3>
      <div class="mt-2 max-w-xl text-sm text-gray-500">
        <p>Fill in the details below to schedule your appointment with a healthcare professional.</p>
      </div>
      <form method="POST" class="mt-5 space-y-6">
        <!-- Doctor Selection -->
        <div>
          <label for="doctor" class="block text-sm font-medium text-gray-700">Select Doctor</label>
          <select id="doctor" name="doctor" required
                  class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
            <option value="" disabled selected>Choose a doctor</option>
            {% for doctor in doctors %}
            <option value="{{ doctor.id }}" data-schedule='{{ doctor.schedule|tojson }}'>
              Dr. {{ doctor.name }} - {{ doctor.specialty }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- Doctor's Schedule -->
        <div id="doctor-schedule" class="hidden">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Doctor's Weekly Schedule</h4>
          <div class="grid grid-cols-7 gap-2 text-center text-xs">
            <div class="font-medium text-gray-500">Mon</div>
            <div class="font-medium text-gray-500">Tue</div>
            <div class="font-medium text-gray-500">Wed</div>
            <div class="font-medium text-gray-500">Thu</div>
            <div class="font-medium text-gray-500">Fri</div>
            <div class="font-medium text-gray-500">Sat</div>
            <div class="font-medium text-gray-500">Sun</div>
            <div id="mon-hours" class="p-2 bg-gray-50 rounded"></div>
            <div id="tue-hours" class="p-2 bg-gray-50 rounded"></div>
            <div id="wed-hours" class="p-2 bg-gray-50 rounded"></div>
            <div id="thu-hours" class="p-2 bg-gray-50 rounded"></div>
            <div id="fri-hours" class="p-2 bg-gray-50 rounded"></div>
            <div id="sat-hours" class="p-2 bg-gray-50 rounded"></div>
            <div id="sun-hours" class="p-2 bg-gray-50 rounded"></div>
          </div>
        </div>

        <!-- Appointment Type -->
        <div>
          <label for="type" class="block text-sm font-medium text-gray-700">Appointment Type</label>
          <select id="type" name="type" required
                  class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
            <option value="" disabled selected>Select appointment type</option>
            <option value="consultation">Consultation</option>
            <option value="follow-up">Follow-up</option>
            <option value="checkup">Regular Checkup</option>
            <option value="emergency">Emergency</option>
          </select>
        </div>

        <!-- Available Days -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Select Available Day</label>
          <div id="available-days" class="mt-2 grid grid-cols-7 gap-2">
            <!-- Days will be inserted here -->
          </div>
          <input type="hidden" id="selected-date" name="date" required>
        </div>

        <!-- Reason for Visit -->
        <div>
          <label for="reason" class="block text-sm font-medium text-gray-700">Reason for Visit</label>
          <textarea id="reason" name="reason" rows="3"
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    placeholder="Please describe your reason for the appointment"></textarea>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end">
          <button type="submit"
                  class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-calendar-plus mr-2"></i>
            Book Appointment
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% block javascript %}
<script>
  // Format time to 12-hour format
  function formatTime(timeStr) {
    const [hours, minutes] = timeStr.split(':');
    const date = new Date();
    date.setHours(parseInt(hours), parseInt(minutes));
    return date.toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
  }

  // Get doctor's schedule
  function getDoctorSchedule(doctorId) {
    const selectedOption = document.querySelector(`#doctor option[value="${doctorId}"]`);
    const schedule = JSON.parse(selectedOption.dataset.schedule);
    if (!schedule) {
      return;
    }
    document.getElementById('doctor-schedule').classList.remove('hidden');
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const dayElements = {
      'monday': 'mon-hours',
      'tuesday': 'tue-hours',
      'wednesday': 'wed-hours',
      'thursday': 'thu-hours',
      'friday': 'fri-hours',
      'saturday': 'sat-hours',
      'sunday': 'sun-hours'
    };
    days.forEach(day => {
      const element = document.getElementById(dayElements[day]);
      const daySchedule = schedule[day];
      if (daySchedule && daySchedule.length > 0) {
        const ranges = daySchedule.map(range => `${formatTime(range.start)} - ${formatTime(range.end)}`);
        element.innerHTML = ranges.join('<br>');
        element.classList.add('bg-green-50', 'text-green-700');
        element.classList.remove('bg-red-50', 'text-red-700');
      } else {
        element.innerHTML = 'Not available';
        element.classList.add('bg-red-50', 'text-red-700');
        element.classList.remove('bg-green-50', 'text-green-700');
      }
    });
    updateAvailableDays(schedule);
  }

  // Update available days
  function updateAvailableDays(schedule) {
    const availableDays = document.getElementById('available-days');
    availableDays.innerHTML = '';
    const today = new Date();
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    
    // Show next 14 days
    for (let i = 0; i < 14; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      const dayOfWeek = dayNames[date.getDay()];
      const hasSchedule = schedule[dayOfWeek] && schedule[dayOfWeek].length > 0;
      
      const button = document.createElement('button');
      button.type = 'button';
      button.className = `p-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${
        hasSchedule ? 'hover:bg-blue-50 hover:border-blue-500' : 'bg-gray-50 text-gray-400 cursor-not-allowed'
      }`;
      button.textContent = `${days[date.getDay()]} ${date.getDate()}`;
      button.value = date.toISOString().split('T')[0];
      button.disabled = !hasSchedule;
      
      if (hasSchedule) {
        button.onclick = function() {
          // Remove selected state from all buttons
          document.querySelectorAll('#available-days button').forEach(btn => {
            btn.classList.remove('bg-blue-500', 'text-white');
            btn.classList.add('border-gray-300');
          });
          // Add selected state to clicked button
          this.classList.add('bg-blue-500', 'text-white');
          this.classList.remove('border-gray-300');
          // Update hidden input
          document.getElementById('selected-date').value = this.value;
          // Show time selection
          document.getElementById('time-selection').classList.remove('hidden');
          // Update time slots
          updateTimeSlots();
        };
      }
      
      availableDays.appendChild(button);
    }
  }

  // Update available time slots
  function updateTimeSlots() {
    const date = document.getElementById('selected-date').value;
    const doctorId = document.getElementById('doctor').value;
    const timeSlotsContainer = document.getElementById('time-slots');
    const timeMessage = document.getElementById('time-message');
    const selectedTimeInput = document.getElementById('selected-time');
    
    if (!date || !doctorId) {
      timeSlotsContainer.innerHTML = '';
      timeMessage.textContent = 'Please select both a doctor and date first';
      selectedTimeInput.value = '';
      return;
    }
    
    timeSlotsContainer.innerHTML = '<div class="col-span-4 text-center py-4">Loading available slots...</div>';
    timeMessage.textContent = 'Loading available time slots...';
    selectedTimeInput.value = '';
    
    // Fetch available time slots from the server
    fetch(`/get_available_slots?doctor_id=${doctorId}&date=${date}`)
      .then(response => response.json())
      .then(data => {
        timeSlotsContainer.innerHTML = '';
        
        if (data.error) {
          timeMessage.textContent = data.error;
          return;
        }
        
        if (!data.slots || data.slots.length === 0) {
          timeMessage.textContent = 'No available time slots for the selected date';
          return;
        }
        
        data.slots.forEach(slot => {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'p-2 text-sm border rounded-md hover:bg-blue-50 hover:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2';
          button.textContent = formatTime(slot);
          button.value = slot;
          button.onclick = function() {
            // Remove selected state from all buttons
            document.querySelectorAll('#time-slots button').forEach(btn => {
              btn.classList.remove('bg-blue-500', 'text-white');
              btn.classList.add('border-gray-300');
            });
            // Add selected state to clicked button
            this.classList.add('bg-blue-500', 'text-white');
            this.classList.remove('border-gray-300');
            // Update hidden input
            selectedTimeInput.value = this.value;
          };
          timeSlotsContainer.appendChild(button);
        });
        
        timeMessage.textContent = `${data.slots.length} time slots available`;
      })
      .catch(error => {
        console.error('Time slots fetch error:', error);
        timeSlotsContainer.innerHTML = '';
        timeMessage.textContent = 'Error loading time slots. Please try again.';
      });
  }

  // Add event listeners
  document.getElementById('doctor').addEventListener('change', function() {
    const doctorId = this.value;
    if (doctorId) {
      getDoctorSchedule(doctorId);
    } else {
      document.getElementById('doctor-schedule').classList.add('hidden');
      document.getElementById('time-selection').classList.add('hidden');
    }
  });

  // Initialize if doctor is pre-selected
  const selectedDoctor = document.getElementById('doctor').value;
  if (selectedDoctor) {
    getDoctorSchedule(selectedDoctor);
  }
</script>
{% endblock %}
{% endblock %} 